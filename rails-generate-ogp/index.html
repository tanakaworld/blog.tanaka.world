<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Rails ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã« OGP ç”»åƒã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒãƒ³ã‚ºã‚ªãƒ³ | For X Developers</title><meta name="description" content="Rails ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã« OGP ç”»åƒã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒãƒ³ã‚ºã‚ªãƒ³ - tanakaworld"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><meta name="description" content="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ï¼Œãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã« OGP ç”»åƒã‚’è‡ªå‹•ç”Ÿæˆã—è¡¨ç¤ºã•ã›ã¦ã¿ã‚‹ï¼ å®Œæˆç‰ˆã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ ğŸ‘‰ rails_ogp_generator_sampleï¼ å‰ææ¡ä»¶ Ruby 2.4.2 Rails 5.1.6 RMagic 2.16.0  Gemç”»åƒç”Ÿæˆã§ rmagicï¼Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã« carrierwave ã‚’ä½¿ã†ï¼ 1234# Gemfileg">
<meta name="keywords" content="rails,ogp,rmagic">
<meta property="og:type" content="article">
<meta property="og:title" content="Rails ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã« OGP ç”»åƒã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒãƒ³ã‚ºã‚ªãƒ³">
<meta property="og:url" content="https:&#x2F;&#x2F;blog.tanaka.world&#x2F;rails-generate-ogp&#x2F;index.html">
<meta property="og:site_name" content="For X Developers">
<meta property="og:description" content="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ï¼Œãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã« OGP ç”»åƒã‚’è‡ªå‹•ç”Ÿæˆã—è¡¨ç¤ºã•ã›ã¦ã¿ã‚‹ï¼ å®Œæˆç‰ˆã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ ğŸ‘‰ rails_ogp_generator_sampleï¼ å‰ææ¡ä»¶ Ruby 2.4.2 Rails 5.1.6 RMagic 2.16.0  Gemç”»åƒç”Ÿæˆã§ rmagicï¼Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã« carrierwave ã‚’ä½¿ã†ï¼ 1234# Gemfileg">
<meta property="og:locale" content="en">
<meta property="og:image" content="https:&#x2F;&#x2F;blog.tanaka.world&#x2F;favicon.png">
<meta property="og:updated_time" content="2020-12-25T03:35:42.649Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;blog.tanaka.world&#x2F;favicon.png"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.tanaka.world/atom.xml" title="For X Developers"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"><h1 class="title">For X Developers</h1></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://tanaka.world/about" target="_blank" class="nav-list-link">AUTHOR</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Rails ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã« OGP ç”»åƒã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒãƒ³ã‚ºã‚ªãƒ³</h1><div class="post-info">Aug 8, 2018<div class="tags-list"><div class="tags-list-item"><a href="/tags/rails/" class="tags-list-item-link">#rails</a></div><div class="tags-list-item"><a href="/tags/ogp/" class="tags-list-item-link">#ogp</a></div><div class="tags-list-item"><a href="/tags/rmagic/" class="tags-list-item-link">#rmagic</a></div></div></div><div class="post-content"><p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ï¼Œãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã« OGP ç”»åƒã‚’è‡ªå‹•ç”Ÿæˆã—è¡¨ç¤ºã•ã›ã¦ã¿ã‚‹ï¼</p>
<p>å®Œæˆç‰ˆã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ ğŸ‘‰ <a href="https://github.com/tanakaworld/rails_ogp_generator_sample" target="_blank" rel="noopener">rails_ogp_generator_sample</a>ï¼</p>
<h2 id="å‰ææ¡ä»¶"><a href="#å‰ææ¡ä»¶" class="headerlink" title="å‰ææ¡ä»¶"></a>å‰ææ¡ä»¶</h2><ul>
<li>Ruby <code>2.4.2</code></li>
<li>Rails <code>5.1.6</code></li>
<li>RMagic <code>2.16.0</code></li>
</ul>
<h2 id="Gem"><a href="#Gem" class="headerlink" title="Gem"></a>Gem</h2><p>ç”»åƒç”Ÿæˆã§ <a href="https://github.com/rmagick/rmagick" target="_blank" rel="noopener">rmagic</a>ï¼Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã« <a href="https://github.com/carrierwaveuploader/carrierwave" target="_blank" rel="noopener">carrierwave</a> ã‚’ä½¿ã†ï¼</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Gemfile</span></span><br><span class="line"></span><br><span class="line">gem <span class="string">'rmagick'</span></span><br><span class="line">gem <span class="string">'carrierwave'</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bundle install</span><br></pre></td></tr></table></figure>

<h2 id="User-ã®-Scaffold-ã‚’ä½œæˆ"><a href="#User-ã®-Scaffold-ã‚’ä½œæˆ" class="headerlink" title="User ã® Scaffold ã‚’ä½œæˆ"></a>User ã® Scaffold ã‚’ä½œæˆ</h2><p><code>name</code> ã¨ <code>avatar</code> ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® Scaffold ã‚’ä½œæˆã™ã‚‹ï¼</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bundle <span class="built_in">exec</span> rails g scaffold User name:string avatar:text</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># db/migrate/20180720144053_create_users.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateUsers</span> &lt; ActiveRecord::Migration[5.1]</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">change</span></span></span><br><span class="line">    create_table <span class="symbol">:users</span> <span class="keyword">do</span> <span class="params">|t|</span></span><br><span class="line">      t.string <span class="symbol">:name</span>, <span class="symbol">null:</span> <span class="literal">false</span></span><br><span class="line">      t.text <span class="symbol">:avatar</span></span><br><span class="line"></span><br><span class="line">      t.timestamps</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bundle <span class="built_in">exec</span> rails db:migrate</span><br></pre></td></tr></table></figure>


<h2 id="UserOgpImage-ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ"><a href="#UserOgpImage-ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ" class="headerlink" title="UserOgpImage ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ"></a>UserOgpImage ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ</h2><p>User ã® OGP ç”»åƒã‚’ä¿æŒã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã™ã‚‹ï¼</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bundle <span class="built_in">exec</span> rails g model UserOgpImage user:references image:text</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># db/migrate/20180725031431_create_user_ogp_images.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateUserOgpImages</span> &lt; ActiveRecord::Migration[5.1]</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">change</span></span></span><br><span class="line">    create_table <span class="symbol">:user_ogp_images</span> <span class="keyword">do</span> <span class="params">|t|</span></span><br><span class="line">      t.references <span class="symbol">:user</span>, <span class="symbol">foreign_key:</span> <span class="literal">true</span>, <span class="symbol">null:</span> <span class="literal">false</span></span><br><span class="line">      t.text <span class="symbol">:image</span></span><br><span class="line"></span><br><span class="line">      t.timestamps</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bundle <span class="built_in">exec</span> rails db:migrate</span><br></pre></td></tr></table></figure>

<h2 id="Uploader-ã‚’ä½œæˆ"><a href="#Uploader-ã‚’ä½œæˆ" class="headerlink" title="Uploader ã‚’ä½œæˆ"></a>Uploader ã‚’ä½œæˆ</h2><p><code>user.avatar</code> ã¨ ç”Ÿæˆã—ãŸ OGP ç”»åƒç”¨ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹ï¼</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ bundle <span class="built_in">exec</span> rails g uploader UserAvatar</span><br><span class="line">$ bundle <span class="built_in">exec</span> rails g uploader UserOgpImage</span><br></pre></td></tr></table></figure>

<h2 id="ãƒ¢ãƒ‡ãƒ«ã®é–¢é€£ã‚’è¿½è¨˜"><a href="#ãƒ¢ãƒ‡ãƒ«ã®é–¢é€£ã‚’è¿½è¨˜" class="headerlink" title="ãƒ¢ãƒ‡ãƒ«ã®é–¢é€£ã‚’è¿½è¨˜"></a>ãƒ¢ãƒ‡ãƒ«ã®é–¢é€£ã‚’è¿½è¨˜</h2><p>User ãŒ OGP ç”»åƒã‚’1å€‹ã‚‚ã¤ã‚ˆã†ã«ã™ã‚‹ï¼</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/models/user.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &lt; ApplicationRecord</span></span><br><span class="line">  has_one <span class="symbol">:user_ogp_image</span>, <span class="symbol">dependent:</span> <span class="symbol">:destroy</span></span><br><span class="line"></span><br><span class="line">  mount_uploader <span class="symbol">:avatar</span>, UserAvatarUploader</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/models/user_ogp_image.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserOgpImage</span> &lt; ApplicationRecord</span></span><br><span class="line">  belongs_to <span class="symbol">:user</span></span><br><span class="line"></span><br><span class="line">  mount_uploader <span class="symbol">:image</span>, UserOgpImageUploader</span><br><span class="line"></span><br><span class="line">  validates <span class="symbol">:user</span>, <span class="symbol">presence:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">url</span></span></span><br><span class="line">    image.url</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="OGP-ç”»åƒç”Ÿæˆå‡¦ç†ã‚’å®Ÿè£…"><a href="#OGP-ç”»åƒç”Ÿæˆå‡¦ç†ã‚’å®Ÿè£…" class="headerlink" title="OGP ç”»åƒç”Ÿæˆå‡¦ç†ã‚’å®Ÿè£…"></a>OGP ç”»åƒç”Ÿæˆå‡¦ç†ã‚’å®Ÿè£…</h2><p><code>ApplicationRecord</code> ã‚’ç¶™æ‰¿ã—ãªã„ï¼Œãƒ—ãƒ¬ãƒ¼ãƒ³ãª Ruby ã‚¯ãƒ©ã‚¹ã§å®Ÿè£…ã™ã‚‹ï¼</p>
<p>OGP ç”»åƒã«ã‚¢ãƒã‚¿ãƒ¼ã¨åå‰ã‚’è¡¨ç¤ºã™ã‚‹ï¼1200x630 ã® Image ã‚’ä½œæˆã—ï¼Œãã“ã« <code>user.avatar</code> ã¨ <code>user.name</code> ã‚’åˆæˆã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼<br><code>Magic::Draw</code> ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã« <code>font</code> ã‚’è¨­å®šã—ãªã„ã¨æ—¥æœ¬èªãŒæ–‡å­—åŒ–ã‘ã™ã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ï¼</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/models/user_ogp_image_generator.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserOgpImageGenerator</span></span></span><br><span class="line">  <span class="keyword">include</span> Magick</span><br><span class="line"></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:user</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(user)</span></span></span><br><span class="line">    @user = user</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate</span></span></span><br><span class="line">    user_id = @user.id</span><br><span class="line">    user_name = @user.name</span><br><span class="line">	</span><br><span class="line">    <span class="comment"># host ã‚’æŒ‡å®šã™ã‚‹ã“ã¨</span></span><br><span class="line">    avatar_path = @user.avatar.present? ?</span><br><span class="line">                      user.avatar.url</span><br><span class="line">                      : ActionController::Base.helpers.image_path(<span class="string">'default-avatar.png'</span>, <span class="symbol">host:</span> <span class="string">'http://localhost:3000'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1200x630 ã®å¤§ãã•ã®ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ</span></span><br><span class="line">    image = Magick::ImageList.new</span><br><span class="line">    image.new_image(<span class="number">1200</span>, <span class="number">630</span>) <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">self</span>.background_color = <span class="string">'#e5e5e5'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ–‡å­—ã®è¨­å®š</span></span><br><span class="line">    draw = Magick::Draw.new</span><br><span class="line">    draw.gravity = Magick::CenterGravity</span><br><span class="line">    draw.font = Rails.root.join(<span class="string">'app'</span>, <span class="string">'assets'</span>, <span class="string">'fonts'</span>, <span class="string">'NotoSansCJKjp-Medium.otf'</span>).to_s</span><br><span class="line">    draw.fill = <span class="string">'white'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># avatar</span></span><br><span class="line">    avatar_image = Magick::Image.from_blob(open(avatar_path).read).first</span><br><span class="line">    avatar_image = avatar_image.resize(<span class="number">320</span>, <span class="number">320</span>)</span><br><span class="line">    image.composite!(avatar_image, Magick::CenterGravity, <span class="number">0</span>, -<span class="number">80</span>, Magick::OverCompositeOp)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># name</span></span><br><span class="line">    <span class="keyword">if</span> user_name.present?</span><br><span class="line">      draw.pointsize = <span class="number">58</span></span><br><span class="line">      draw.annotate(image, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">155</span>, user_name) &#123;</span><br><span class="line">        <span class="keyword">self</span>.fill = <span class="string">'#333'</span></span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    dist_dir = <span class="string">"<span class="subst">#&#123;Rails.root.join(<span class="string">'tmp'</span>, <span class="string">'ogp_image'</span>)&#125;</span>"</span></span><br><span class="line">    Dir.mkdir(dist_dir) <span class="keyword">unless</span> File.exists?(dist_dir)</span><br><span class="line">    dist_path = <span class="string">"<span class="subst">#&#123;dist_dir&#125;</span>/<span class="subst">#&#123;user_id&#125;</span>-<span class="subst">#&#123;user_name&#125;</span>.png"</span></span><br><span class="line">    image.write(dist_path)</span><br><span class="line">    dist_path</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>UserOgpImageGenerator</code> ã‚¯ãƒ©ã‚¹ã« <code>User</code> ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ¸¡ã™ã¨ï¼ŒOPGç”»åƒãŒç”Ÿæˆã•ã‚Œã‚‹ï¼<br>ç”»åƒã¯ <code>tmp/</code> ä»¥ä¸‹ã«ç”Ÿæˆã•ã‚Œï¼Œãã®çµ¶å¯¾ãƒ‘ã‚¹ãŒè¿”ã‚‹ï¼</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ogp_image_generator = UserOgpImageGenerator.new(User.first)</span><br><span class="line">file_path = ogp_image_generator.generate</span><br></pre></td></tr></table></figure>

<h2 id="OGP-ç”Ÿæˆã‚’çµ„ã¿è¾¼ã‚€"><a href="#OGP-ç”Ÿæˆã‚’çµ„ã¿è¾¼ã‚€" class="headerlink" title="OGP ç”Ÿæˆã‚’çµ„ã¿è¾¼ã‚€"></a>OGP ç”Ÿæˆã‚’çµ„ã¿è¾¼ã‚€</h2><p>User æƒ…å ± <code>name</code> <code>avatar</code> ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ï¼ŒOGP ç”»åƒã‚’æ›´æ–°ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &lt; ApplicationRecord</span></span><br><span class="line">  â€¢â€¢â€¢</span><br><span class="line"></span><br><span class="line">  after_save <span class="symbol">:generate_ogp_image</span>, <span class="symbol">if:</span> <span class="symbol">:ogp_image_info_changed?</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">ogp_image_info_changed?</span></span></span><br><span class="line">    name_changed? <span class="params">||</span> avatar_changed?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">generate_ogp_image</span></span></span><br><span class="line">    ogp_image_generator = UserOgpImageGenerator.new(<span class="keyword">self</span>)</span><br><span class="line">    file_path = ogp_image_generator.generate</span><br><span class="line"></span><br><span class="line">    tmp_user_ogp_image = user_ogp_image.present? ? user_ogp_image : UserOgpImage.new(<span class="symbol">user:</span> <span class="keyword">self</span>)</span><br><span class="line">    tmp_user_ogp_image.image = File.open(file_path)</span><br><span class="line">    tmp_user_ogp_image.save!</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>æ¬¡ã®ã‚ˆã†ã«ï¼Œã‚¢ãƒã‚¿ãƒ¼ã‚’æŒ‡å®šã•ã‚ŒãŸã¨ãã¯ãã®ã‚¢ãƒã‚¿ãƒ¼æƒ…å ±ãŒå…¥ã‚‹ï¼</p>
<p><img src="https://user-images.githubusercontent.com/3489430/43838431-4d451c84-9b56-11e8-9058-b575d5876a83.png" alt="image"></p>
<h2 id="ã‚¢ãƒã‚¿ãƒ¼ã‚’å††ã§ãã‚ŠæŠœã"><a href="#ã‚¢ãƒã‚¿ãƒ¼ã‚’å††ã§ãã‚ŠæŠœã" class="headerlink" title="ã‚¢ãƒã‚¿ãƒ¼ã‚’å††ã§ãã‚ŠæŠœã"></a>ã‚¢ãƒã‚¿ãƒ¼ã‚’å††ã§ãã‚ŠæŠœã</h2><p>UserOgpImageGenerator ã‚’æ‹¡å¼µã—ã¦ï¼ŒOGP ç”»åƒã§ã‚ˆãã‚„ã‚‰ã‚Œã¦ã„ã‚‹ã‚¢ãƒã‚¿ãƒ¼ã‚’å††ã§ãã‚ŠæŠœãã®ã‚’ã‚„ã£ã¦ã¿ã‚‹ï¼<br>Circle ç”»åƒã‚’ç”Ÿæˆã—ï¼Œãã®ç”»åƒã§ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’ãƒã‚¹ã‚¯ã™ã‚‹ï¼</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_circle_mask</span><span class="params">(image, size)</span></span></span><br><span class="line">    circle_image = Magick::Image.new(size, size)</span><br><span class="line">    draw = Magick::Draw.new</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ref: https://rmagick.github.io/draw.html#circle</span></span><br><span class="line">    draw.circle(size / <span class="number">2</span>, size / <span class="number">2</span>, size / <span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">    draw.draw(circle_image)</span><br><span class="line">    mask = circle_image.blur_image(<span class="number">0</span>, <span class="number">1</span>).negate</span><br><span class="line">    mask.matte = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    image.matte = <span class="literal">true</span></span><br><span class="line">    image.composite!(mask, Magick::CenterGravity, Magick::CopyOpacityCompositeOp)</span><br><span class="line"></span><br><span class="line">    image</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>avatar_image</code> ã‚’ <code>image.composite!</code> ã™ã‚‹å‰ã«ãã‚ŠæŠœãå‡¦ç†ã‚’æŒŸã‚ã°OKï¼</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">avatar_image = make_circle_mask(avatar_image, <span class="number">320</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/3489430/43838535-9d1e44e2-9b56-11e8-8826-e259eb13443d.png" alt="image"></p>
<h2 id="ã¾ã¨ã‚"><a href="#ã¾ã¨ã‚" class="headerlink" title="ã¾ã¨ã‚"></a>ã¾ã¨ã‚</h2><ul>
<li><a href="https://github.com/tanakaworld/rails_ogp_generator_sample" target="_blank" rel="noopener">rails_ogp_generator_sample</a></li>
</ul>
<p>ä»Šå›ã¯ãƒ¢ãƒ‡ãƒ«ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ OGP ã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«ã—ãŸãŒï¼Œå‡¦ç†ãŒé‡ããªã‚‹ã‚ˆã†ãªã‚‰éåŒæœŸã§å‡¦ç†ã™ã‚‹ã‚ˆã†ã«ã—ãŸæ–¹ãŒã‚ˆã•ãã†ï¼</p>
</div></article></div></main><footer><div class="share-buttons"><ul class="share-buttons-list"><li class="share-buttons-list-item"><a data-fullpath="https://blog.tanaka.world/rails-generate-ogp/index.html" href="https://twitter.com/intent/tweet?text=Rails ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã« OGP ç”»åƒã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒãƒ³ã‚ºã‚ªãƒ³&amp;url=https://blog.tanaka.world/rails-generate-ogp/&amp;via=_tanakaworld" onclick="window.open(https://blog.tanaka.world/rails-generate-ogp/, 'twitter-share', 'width=550,height=235');return false;" target="_blank" class="icon icon-twitter"><img src="/images/icon-twitter.svg"></a></li><li class="share-buttons-list-item"><a href="https://www.facebook.com/sharer/sharer.php?u=https://blog.tanaka.world/rails-generate-ogp/" data-fullpath="https://blog.tanaka.world/rails-generate-ogp/index.html" onclick="window.open(https://blog.tanaka.world/rails-generate-ogp/, 'facebook-share','width=580,height=296');return false;" target="_blank" class="icon icon-facebook"><img src="/images/icon-facebook.svg"></a></li><!--li.share-buttons-list-item--><!--    a.icon.icon-pocket(data-fullpath=url href="https://getpocket.com/edit?url=#{share_url}&title=#{title}" onclick="window.open(#{share_url}, 'google-plus-share', 'width=490,height=530');return false;" target="_blank")--><!--        img(src="/images/icon-twitter.svg")--><li class="share-buttons-list-item"><a data-fullpath="https://blog.tanaka.world/rails-generate-ogp/index.html" href="https://plus.google.com/share?url=https://blog.tanaka.world/rails-generate-ogp/" onclick="window.open(https://blog.tanaka.world/rails-generate-ogp/, 'google-plus-share', 'width=490,height=530');return false;" target="_blank" class="icon icon-google-plus"><img src="/images/icon-google-plus.svg"></a></li></ul></div><div class="paginator"><a href="/vue-wysiwyg-editor-with-atjs/" class="prev">&laquo; PREV</a><a href="/emacs-2018/" class="next">NEXT &raquo;</a></div><div class="copyright"><p>Â© 2014 - 2021 <a href="https://blog.tanaka.world">tanakaworld</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/tanakaworld/hexo-theme-apollo" target="_blank">Forked of hexo-theme-apollo</a>.</p></div></footer></div><!--script(async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous")--><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-122034388-1",'auto');ga('send','pageview');</script></body></html>